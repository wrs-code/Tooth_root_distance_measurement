# 牙齿CEJ线检测与根部距离测量系统

## 项目简介

本系统基于全景X光片自动检测每颗牙齿的CEJ线（Cemento-Enamel Junction，釉牙骨质界），并沿CEJ线的法线方向测量牙根深度和相邻牙齿间距，用于口腔正畸风险评估。

## 主要功能

1. **自动牙齿检测** - 从全景X光片中自动识别和分割每颗牙齿
2. **CEJ线识别** - 基于牙齿轮廓宽度变化梯度自动检测CEJ线位置
3. **法线方向测量** - 沿CEJ线的法线方向（垂直于CEJ线切线）进行深度测量
4. **间距分析** - 测量相邻牙齿在不同深度的间距
5. **风险评估** - 根据间距值进行颜色编码：
   - 🔴 红色：< 3.2mm（危险）
   - 🟡 黄色：3.2-4.0mm（相对安全）
   - 🟢 绿色：≥ 4.0mm（安全）
6. **批量处理** - 支持处理input文件夹中的所有图片
7. **可视化报告** - 生成详细的4视图分析结果和汇总报告

## 技术实现

### 核心算法

#### 1. 牙齿边缘检测与分割
```python
- 预处理：CLAHE增强对比度 + 双边滤波降噪
- 二值化：Otsu自动阈值
- 形态学操作：开运算去噪 + 闭运算填充
- 连通组件分析（CCA）：分离单颗牙齿
- 轮廓提取：获取每颗牙齿的精确边界
```

#### 2. CEJ线检测算法
```python
算法原理：
- CEJ线位于牙冠和牙根的交界处
- 特征：该位置牙齿轮廓宽度开始显著减小
- 方法：
  1. 从上到下扫描牙齿轮廓，记录每个Y坐标的宽度
  2. 对宽度曲线进行高斯平滑
  3. 计算宽度变化梯度（一阶导数）
  4. 在牙齿中上部（20%-60%高度）寻找最大负梯度位置
  5. 该位置即为CEJ线
```

#### 3. 法线方向深度测量
```python
算法原理：
- 计算CEJ线的切线方向（沿着CEJ线）
- 法线方向 = 切线方向旋转90度（垂直于CEJ线）
- 沿法线方向从CEJ线向根尖采样
- 在每个深度切片处，垂直于法线方向寻找牙齿边界
```

#### 4. 间距测量与颜色编码
```python
对每对相邻牙齿：
- 在相同深度切片处找到两颗牙齿的边界
- 计算左牙齿右边界与右牙齿左边界的距离
- 根据间距值映射到颜色（红/黄/绿）
- 绘制颜色填充区域和深度-间距曲线
```

## 安装依赖

```bash
pip install opencv-python-headless numpy matplotlib scipy
```

或使用项目requirements.txt：
```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 准备输入图片

将全景X光片放入 `input` 文件夹：
```
input/
├── patient1.png
├── patient2.jpg
└── patient3.png
```

### 2. 运行程序

```bash
python tooth_cej_root_analyzer.py
```

### 3. 查看结果

程序会在 `output` 文件夹生成：

**可视化分析图（每张输入图片一个）：**
- 文件名：`<原图名>_analysis.png`
- 包含4个视图：
  1. 牙齿检测与CEJ线标注
  2. CEJ线法线方向深度测量
  3. 牙齿间距颜色编码热力图
  4. 间距随深度变化曲线

**汇总报告：**
- 文件名：`summary_report.txt`
- 包含所有图片的统计信息和风险分布

## 示例输出

### 控制台输出
```
============================================================
牙齿CEJ线检测与根部距离测量系统
============================================================

[1/1]
============================================================
分析图像: image.png
============================================================
✓ 图像尺寸: 500x459
正在预处理图像...
正在检测牙齿轮廓...
✓ 检测到 4 颗牙齿
正在检测CEJ线...
  牙齿 1: CEJ线位于 Y=93
  牙齿 2: CEJ线位于 Y=64
  牙齿 3: CEJ线位于 Y=149
  牙齿 4: CEJ线位于 Y=87
正在测量牙根深度...
  牙齿 1: 根部深度 8.5mm
  牙齿 2: 根部深度 4.5mm
  牙齿 3: 根部深度 4.5mm
  牙齿 4: 根部深度 3.0mm
正在测量牙齿间距...
  牙齿 1-2: 最小间距 -3.40mm (危险)
  牙齿 2-3: 最小间距 6.70mm (安全)
  牙齿 3-4: 最小间距 9.10mm (安全)
✓ 可视化结果已保存: output/image_analysis.png
```

### 汇总报告示例
```
================================================================================
牙齿CEJ线检测与根部距离测量 - 汇总报告
================================================================================

图像: image.png
  检测到牙齿数量: 4
  相邻牙齿对数: 3

    牙齿 1 - 2:
      最小间距: -3.40mm
      平均间距: -2.90mm
      风险等级: 危险

    牙齿 2 - 3:
      最小间距: 6.70mm
      平均间距: 8.67mm
      风险等级: 安全

================================================================================
总体统计
================================================================================
处理图像数: 1
检测牙齿总数: 4
测量间距总数: 3

风险分布:
  危险 (< 3.2mm): 1 (33.3%)
  相对安全 (3.2-4.0mm): 0 (0.0%)
  安全 (≥ 4.0mm): 2 (66.7%)
================================================================================
```

## 参数调整

可以在代码中调整以下参数：

```python
class ToothCEJAnalyzer:
    def __init__(self):
        # 风险阈值（毫米）
        self.DANGER_THRESHOLD = 3.2     # 危险阈值
        self.WARNING_THRESHOLD = 4.0    # 警告阈值

        # 像素到毫米转换比例
        self.pixels_per_mm = 10         # 根据实际X光片校准
```

## 项目结构

```
Tooth_root_distance_measurement/
├── input/                                    # 输入文件夹
│   └── image.png                            # 示例X光片
├── output/                                  # 输出文件夹（自动生成）
│   ├── image_analysis.png                   # 可视化分析结果
│   └── summary_report.txt                   # 汇总报告
├── Segmentation-of-Teeth-in-Panoramic-X-ray-Image-Using-U-Net/
│   └── ...                                  # U-Net开源仓库（参考）
├── tooth_cej_root_analyzer.py              # 主程序（新增）
├── tooth_spacing_color_demo.py             # 旧版模拟演示
├── requirements.txt                         # Python依赖
├── .gitignore                              # Git忽略文件（新增）
├── README.md                               # 项目总体说明
├── CEJ_ANALYSIS_README.md                  # 本文件
└── 牙根距离测量方法说明.md                 # 方法详细说明
```

## 关键技术点

### 1. CEJ线定位精度
- 使用梯度分析代替固定比例估计
- 高斯平滑减少噪声影响
- 限制搜索范围提高准确性

### 2. 法线方向计算
- 基于CEJ线切线的垂直方向
- 确保法线指向牙根（向下）
- 适应不同角度的牙齿

### 3. 深度采样策略
- 采样间隔：0.5mm（可调整）
- 最大深度：15mm（可扩展）
- 自动停止于根尖处

### 4. 间距测量准确性
- 在相同深度切片比较
- 考虑牙齿的倾斜角度
- 处理牙齿重叠情况

## 未来改进方向

1. **集成深度学习模型**
   - 使用U-Net进行更精确的牙齿分割
   - 训练专门的CEJ线检测模型

2. **3D可视化**
   - 生成牙根间距的3D热力图
   - 交互式查看不同深度的间距

3. **自动校准**
   - 从X光片中识别标尺自动校准像素-毫米比例
   - 根据牙齿标准尺寸估算比例

4. **临床报告生成**
   - 导出PDF格式的专业报告
   - 包含诊断建议和风险评估

5. **多视角支持**
   - 支持根尖片、咬翼片等其他X光类型
   - 融合多视角数据提高准确性

## 技术参考

- **CEJ线检测**：基于文献中的计算机辅助CEJ检测算法
  - "Computer-Assisted Detection of Cemento-Enamel Junction in Intraoral Ultrasonographs"
  - "Evaluation of the Alveolar Crest and Cemento-Enamel Junction in Periodontitis Using Object Detection"

- **牙齿分割**：参考开源项目
  - [Segmentation-of-Teeth-in-Panoramic-X-ray-Image-Using-U-Net](https://github.com/SerdarHelli/Segmentation-of-Teeth-in-Panoramic-X-ray-Image-Using-U-Net)

## 常见问题

**Q: 检测到的牙齿数量不对？**
A: 调整预处理参数（CLAHE、阈值）或形态学操作的迭代次数。

**Q: CEJ线位置不准确？**
A: 这可能是由于X光片质量或牙齿形状异常。可以调整CEJ搜索范围（search_start/search_end）。

**Q: 间距测量结果为负值？**
A: 这表示两颗牙齿有重叠或接触。需要检查牙齿分割是否正确。

**Q: 中文显示为方框？**
A: 这是字体警告，不影响功能。可以安装中文字体或在代码中禁用中文标签。

## 许可证

本项目遵循与原仓库相同的许可证。

## 作者

- 原始仓库：wrs-code
- CEJ分析系统：Claude (Anthropic)

## 联系方式

如有问题或建议，请在GitHub仓库提交Issue。
